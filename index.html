<!-- Everything above remains unchanged (HEAD, STYLES, FORM)... -->

<script>
  const signatureCanvas = document.getElementById("signature");
  const ctx = signatureCanvas.getContext("2d");
  let drawing = false;

  signatureCanvas.addEventListener("mousedown", () => drawing = true);
  signatureCanvas.addEventListener("mouseup", () => {
    drawing = false;
    ctx.beginPath();
  });
  signatureCanvas.addEventListener("mousemove", draw);

  function draw(e) {
    if (!drawing) return;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  }

  function toggleOtherDepartment(show) {
    document.getElementById("otherDepartment").style.display = show ? "block" : "none";
  }

  // Show/hide "Other" inputs on change
  document.getElementById("company").addEventListener("change", function () {
    document.getElementById("otherCompany").style.display = this.value === "Other" ? "block" : "none";
  });

  document.getElementById("material").addEventListener("change", function () {
    document.getElementById("otherMaterial").style.display = this.value === "Other" ? "block" : "none";
  });

  document.getElementById("Quantity").addEventListener("change", function () {
    document.getElementById("otherQuantity").style.display = this.value === "Other" ? "block" : "none";
  });

  async function submitForm() {
    const form = document.getElementById("orderForm");
    const formData = new FormData(form);
    const photos = document.getElementById("photo").files;

    if (photos.length > 5) {
      alert("You can upload a maximum of 5 photos.");
      return;
    }

    for (let i = 0; i < photos.length; i++) {
      formData.append("photo" + i, photos[i]);
    }

    // ⬇️ Override dropdown values with "Other" values if applicable
    const company = document.getElementById("company").value;
    if (company === "Other") {
      const otherCompany = document.getElementById("otherCompany").value;
      document.getElementById("company").value = otherCompany;
    }

    const department = document.querySelector('input[name="akeDepartment"]:checked')?.value;
    if (department === "Other") {
      const otherDept = document.getElementById("otherDepartment").value;
      // Fake a hidden input so html2pdf can pick it up
      const deptLabel = document.createElement("input");
      deptLabel.name = "akeDepartment";
      deptLabel.value = otherDept;
      deptLabel.style.display = "none";
      form.appendChild(deptLabel);
    }

    const material = document.getElementById("material").value;
    if (material === "Other") {
      const otherMaterial = document.getElementById("otherMaterial").value;
      document.getElementById("material").value = otherMaterial;
    }

    const quantity = document.getElementById("Quantity").value;
    if (quantity === "Other") {
      const otherQuantity = document.getElementById("otherQuantity").value;
      document.getElementById("Quantity").value = otherQuantity;
    }

    // ✅ PDF generation
    const opt = {
      margin:       0.5,
      filename:     'order_form.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2 },
      jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(document.getElementById('formToPDF')).toPdf().get('pdf').then(async function(pdf) {
      const pdfBlob = pdf.output("blob");
      formData.append("pdf", pdfBlob, "order_form.pdf");

      const messageDiv = document.getElementById("message");
      try {
        const response = await fetch("https://ake-form-backend.onrender.com/send-pdf", {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          messageDiv.textContent = "✅ Email Delivered";
          messageDiv.style.color = "green";
          document.getElementById("submitBtn").style.display = "none";
        } else {
          messageDiv.textContent = "❌ Submission failed. Please try again.";
          messageDiv.style.color = "red";
        }
      } catch (error) {
        console.error("Error during submission:", error);
        messageDiv.textContent = "❌ Submission failed. Please try again.";
        messageDiv.style.color = "red";
      }
    });
  }
</script>
